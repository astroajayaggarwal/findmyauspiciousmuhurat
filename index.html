<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auspicious Day Analyzer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SunCalc library for sunrise/sunset calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .celestial-gradient { background: linear-gradient(135deg, #fcd34d, #ef4444, #fef3c7); }
        .card {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(209, 213, 219, 0.5);
            color: #1f2937;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0) brightness(0.5);
            cursor: pointer;
        }
        select, input[type="date"], input[type="text"] {
            color: #1f2937;
            background-color: #ffffff;
            border-color: #d1d5db;
        }
        select option { background-color: #ffffff; color: #1f2937; }
        tbody tr:hover { background-color: rgba(0, 0, 0, 0.05); }
        details summary { list-style: none; }
        details summary::-webkit-details-marker { display: none; }
        .current-period {
            background-color: #ecfdf5; /* Tailwind green-50 */
            border-left: 4px solid #10b981; /* Green border to emphasize */
            animation: pulse-active 2s infinite ease-in-out;
        }
        @keyframes pulse-active {
            0%, 100% { background-color: #ecfdf5; }
            50% { background-color: #d1fae5; }
        }
    </style>
</head>
<body class="celestial-gradient text-gray-900 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-7xl mx-auto">
        <!-- Main Analyzer Page -->
        <div id="analyzer-page">
            <div class="card rounded-2xl shadow-2xl p-6 md:p-10">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold tracking-tight flex items-center justify-center text-gray-800">
                        <span class="mr-3 text-yellow-600 text-4xl">&#x2643;</span> Auspicious Day Analyzer <span class="ml-3 text-gray-700 text-4xl">&#x2644;</span>
                    </h1>
                    <p class="text-gray-700 mt-2">Find your favorable days and times based on Vedic astrology.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="nakshatra-select" class="block text-sm font-medium text-gray-700 mb-2">Birth Nakshatra</label>
                        <select id="nakshatra-select" class="w-full border rounded-lg shadow-sm p-3"></select>
                    </div>
                    <div>
                        <label for="rashi-select" class="block text-sm font-medium text-gray-700 mb-2">Birth Moon Rashi</label>
                        <select id="rashi-select" class="w-full border rounded-lg shadow-sm p-3"></select>
                    </div>
                     <div>
                        <label for="location-input" class="block text-sm font-medium text-gray-700 mb-2">Your City Name</label>
                        <input type="text" id="location-input" placeholder="e.g., Delhi" class="w-full border rounded-lg shadow-sm p-3">
                    </div>
                    <div class="md:col-span-1">
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="start-date" class="w-full rounded-lg shadow-sm p-2.5">
                    </div>
                    <div class="md:col-span-1">
                        <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" id="end-date" class="w-full rounded-lg shadow-sm p-2.5">
                    </div>
                </div>

                <button id="analyze-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 shadow-lg">
                    Analyze My Days
                </button>

                <div id="results-container" class="mt-8 hidden">
                    <div id="loader" class="flex justify-center items-center py-8 hidden"><div class="loader"></div><p class="ml-4 text-lg text-gray-700">Analyzing...</p></div>
                    <div id="summary-output" class="mb-6"></div>
                    <div id="output" class="p-1 bg-white/90 rounded-lg border border-gray-200 overflow-x-auto text-gray-800"></div>
                    <div id="error-message" class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
                </div>
            </div>
        </div>

        <!-- Timings Details Page (Hora, Choghadiya, etc.) -->
        <div id="timings-page" class="hidden">
            <div class="card rounded-2xl shadow-2xl p-6 md:p-10">
                 <div class="flex justify-between items-center mb-6">
                    <h2 id="timings-title" class="text-2xl md:text-3xl font-bold text-gray-800">Detailed Timings</h2>
                    <button id="back-to-analyzer-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">&larr; Back to Results</button>
                </div>
                <div id="timings-loader" class="flex justify-center items-center py-8 hidden"><div class="loader"></div><p class="ml-4 text-lg text-gray-700">Calculating timings...</p></div>
                <div id="timings-error" class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
                
                <div id="timings-content" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center mb-8 bg-white p-5 rounded-xl shadow-md">
                        <div><h3 class="text-xl font-bold text-green-700">Sunrise</h3><p id="sunrise-time" class="text-3xl font-extrabold text-green-600"></p></div>
                        <div><h3 class="text-xl font-bold text-orange-700">Sunset</h3><p id="sunset-time" class="text-3xl font-extrabold text-orange-600"></p></div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md border mb-8"><h3 class="text-2xl font-bold text-center p-4 bg-green-600 text-white rounded-t-xl">✨ Best Auspicious Timings ✨</h3><div id="best-times-container" class="overflow-x-auto"></div></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8">
                        <div class="bg-white rounded-xl shadow-md border"><h3 class="text-2xl font-bold text-center p-4 bg-orange-500 text-white rounded-t-xl">Day Hora</h3><div id="day-hora-container" class="overflow-x-auto"></div></div>
                        <div class="bg-white rounded-xl shadow-md border"><h3 class="text-2xl font-bold text-center p-4 bg-indigo-500 text-white rounded-t-xl">Night Hora</h3><div id="night-hora-container" class="overflow-x-auto"></div></div>
                        <div class="bg-white rounded-xl shadow-md border"><h3 class="text-2xl font-bold text-center p-4 bg-purple-500 text-white rounded-t-xl">Day Choghadiya</h3><div id="day-choghadiya-container" class="overflow-x-auto"></div></div>
                        <div class="bg-white rounded-xl shadow-md border"><h3 class="text-2xl font-bold text-center p-4 bg-teal-500 text-white rounded-t-xl">Night Choghadiya</h3><div id="night-choghadiya-container" class="overflow-x-auto"></div></div>
                    </div>
                </div>
            </div>
        </div>
         <footer class="text-center mt-6 text-sm text-gray-700"><p>Disclaimer: This is a tool for spiritual guidance. Consult a professional astrologer for important decisions.</p></footer>
    </div>

    <script>
        // --- DATA AND CONSTANTS ---
        const nakshatras = ["Ashwini", "Bharani", "Krittika", "Rohini", "Mrigashirsha", "Ardra", "Punarvasu", "Pushya", "Ashlesha", "Magha", "Purva Phalguni", "Uttara Phalguni", "Hasta", "Chitra", "Swati", "Vishakha", "Anuradha", "Jyeshtha", "Mula", "Purva Ashadha", "Uttara Ashadha", "Shravana", "Dhanishta", "Shatabhisha", "Purva Bhadrapada", "Uttara Bhadrapada", "Revati"];
        const rashis = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
        const nakshatraToRashi = {"Ashwini": "Aries", "Bharani": "Aries", "Krittika": "Aries", "Rohini": "Taurus", "Mrigashirsha": "Taurus", "Ardra": "Gemini", "Punarvasu": "Gemini", "Pushya": "Cancer", "Ashlesha": "Cancer", "Magha": "Leo", "Purva Phalguni": "Leo", "Uttara Phalguni": "Leo", "Hasta": "Virgo", "Chitra": "Virgo", "Swati": "Libra", "Vishakha": "Libra", "Anuradha": "Scorpio", "Jyeshtha": "Scorpio", "Mula": "Sagittarius", "Purva Ashadha": "Sagittarius", "Uttara Ashadha": "Sagittarius", "Shravana": "Capricorn", "Dhanishta": "Capricorn", "Shatabhisha": "Aquarius", "Purva Bhadrapada": "Aquarius", "Uttara Bhadrapada": "Pisces", "Revati": "Pisces"};
        const taraBalaDescriptions = {'Janma': 'Good for important work', 'Sampat': 'Good for money matters', 'Vipat': 'No travel, no risk', 'Kshema': 'Good for health activities', 'Pratyak': 'Avoid new things & risks', 'Sadhana': 'Good for spiritual practices', 'Naidhana': "Don't start new work or take risks", 'Mitra': 'Good to start new things', 'Ati-Mitra': 'Very good to start new things'};
        
        // --- Hora & Choghadiya Constants ---
        const horaLords = ['Sun', 'Venus', 'Mercury', 'Moon', 'Saturn', 'Jupiter', 'Mars'];
        const BEST_HORA_PLANETS = ['Jupiter', 'Venus', 'Moon', 'Mercury'];
        const CHOGHADIYA_TYPES = {
            LABH: { name: 'Labh', info: 'Good for profit & new ventures.', color: 'text-green-600' }, AMRIT: { name: 'Amrit', info: 'Excellent, good for all work.', color: 'text-green-700' },
            KAAL: { name: 'Kaal', info: 'Inauspicious, avoid new beginnings.', color: 'text-red-600' }, SHUBH: { name: 'Shubh', info: 'Good for auspicious ceremonies.', color: 'text-blue-600' },
            ROG: { name: 'Rog', info: 'Inauspicious, leads to illness.', color: 'text-red-700' }, UDVEG: { name: 'Udveg', info: 'Inauspicious, causes anxiety.', color: 'text-yellow-600' },
            CHAR: { name: 'Char', info: 'Neutral, good for travel.', color: 'text-purple-600' }
        };
        const BEST_CHOGHADIYA_TYPES = ['Labh', 'Amrit', 'Shubh'];
        const CHOGHADIYA_DAY_ORDER = [ // Sun-Sat
            [CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.UDVEG],
            [CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.AMRIT],
            [CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG],
            [CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.LABH],
            [CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.SHUBH],
            [CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.CHAR],
            [CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.KAAL]
        ];
        const CHOGHADIYA_NIGHT_ORDER = [ // Sun-Sat
            [CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.SHUBH],
            [CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.CHAR],
            [CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.LABH],
            [CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG],
            [CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.UDVEG],
            [CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.KAAL],
            [CHOGHADIYA_TYPES.AMRIT, CHOGHADIYA_TYPES.CHAR, CHOGHADIYA_TYPES.ROG, CHOGHADIYA_TYPES.KAAL, CHOGHADIYA_TYPES.LABH, CHOGHADIYA_TYPES.UDVEG, CHOGHADIYA_TYPES.SHUBH, CHOGHADIYA_TYPES.AMRIT]
        ];

        // --- UI ELEMENT REFERENCES ---
        const analyzerPage = document.getElementById('analyzer-page'), timingsPage = document.getElementById('timings-page');
        const selectNakshatraElement = document.getElementById('nakshatra-select'), selectRashiElement = document.getElementById('rashi-select');
        const locationInput = document.getElementById('location-input'), startDateElement = document.getElementById('start-date'), endDateElement = document.getElementById('end-date');
        const analyzeBtn = document.getElementById('analyze-btn'), resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader'), summaryOutputDiv = document.getElementById('summary-output'), outputDiv = document.getElementById('output'), errorMessageDiv = document.getElementById('error-message');
        const backToAnalyzerBtn = document.getElementById('back-to-analyzer-btn'), timingsTitle = document.getElementById('timings-title');
        const timingsLoader = document.getElementById('timings-loader'), timingsError = document.getElementById('timings-error'), timingsContent = document.getElementById('timings-content');
        const sunriseTimeEl = document.getElementById('sunrise-time'), sunsetTimeEl = document.getElementById('sunset-time');
        const bestTimesContainer = document.getElementById('best-times-container'), dayHoraContainer = document.getElementById('day-hora-container'), nightHoraContainer = document.getElementById('night-hora-container');
        const dayChoghadiyaContainer = document.getElementById('day-choghadiya-container'), nightChoghadiyaContainer = document.getElementById('night-choghadiya-container');
        let highlightInterval;

        // --- INITIALIZATION ---
        function populateDropdowns() {
            nakshatras.forEach(n => selectNakshatraElement.add(new Option(n, n)));
            rashis.forEach(r => selectRashiElement.add(new Option(r, r)));
        }
        function setInitialDates() {
            const today = new Date();
            const fiveDaysLater = new Date();
            fiveDaysLater.setDate(today.getDate() + 4);
            startDateElement.value = today.toISOString().split('T')[0];
            endDateElement.value = fiveDaysLater.toISOString().split('T')[0];
        }

        // --- PAGE NAVIGATION ---
        function showAnalyzerPage() { analyzerPage.classList.remove('hidden'); timingsPage.classList.add('hidden'); if(highlightInterval) clearInterval(highlightInterval); }
        function showTimingsPage() { analyzerPage.classList.add('hidden'); timingsPage.classList.remove('hidden'); }

        // --- CORE LOGIC ---
        function getMoonTransitForecast(startDate, endDate) {
            const forecast = [];
            const anchorDate = new Date('2025-07-01T00:00:00Z');
            const anchorNakshatraIndex = nakshatras.indexOf('Uttara Phalguni');
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const diffDays = Math.round((d.getTime() - anchorDate.getTime()) / (1000 * 60 * 60 * 24));
                const transitNakshatraIndex = (anchorNakshatraIndex + diffDays % 27 + 27) % 27;
                const nakshatra = nakshatras[transitNakshatraIndex];
                const rashi = nakshatraToRashi[nakshatra] || "Unknown";
                forecast.push({ date: new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' }), fullDate: new Date(d), nakshatra, rashi });
            }
            return forecast;
        }

        function analyzeTransits(birthNakshatra, birthRashi, transitForecast) {
            const birthNakshatraIndex = nakshatras.indexOf(birthNakshatra), birthRashiIndex = rashis.indexOf(birthRashi);
            const goodTaraBalaGroups = [1, 2, 4, 6, 8, 0], badRashiCounts = [4, 8, 12];
            return transitForecast.map(day => {
                const transitNakshatraIndex = nakshatras.indexOf(day.nakshatra);
                let nakshatraCount = transitNakshatraIndex - birthNakshatraIndex + 1;
                if (nakshatraCount <= 0) nakshatraCount += 27;
                const taraBalaGroup = nakshatraCount % 9;
                const taraType = ['Ati-Mitra', 'Janma', 'Sampat', 'Vipat', 'Kshema', 'Pratyak', 'Sadhana', 'Naidhana', 'Mitra'][taraBalaGroup];
                const isNakshatraGood = goodTaraBalaGroups.includes(taraBalaGroup);
                const transitRashiIndex = rashis.indexOf(day.rashi);
                let rashiCount = transitRashiIndex - birthRashiIndex + 1;
                if (rashiCount <= 0) rashiCount += 12;
                const isRashiGood = !badRashiCounts.includes(rashiCount);
                return { ...day, taraType, isNakshatraGood, isRashiGood, isFinalGood: isNakshatraGood && isRashiGood };
            });
        }
        
        async function getCoordinatesForCity(city) {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${city}&format=json&limit=1`);
            if (!response.ok) throw new Error("Geocoding API failed.");
            const data = await response.json();
            if (data.length === 0) throw new Error(`City "${city}" not found.`);
            return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        }
        
        async function calculateAndDisplayTimings(date, city) {
            showTimingsPage();
            timingsTitle.textContent = `Detailed Timings for ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
            timingsLoader.classList.remove('hidden');
            timingsContent.classList.add('hidden');
            timingsError.classList.add('hidden');
            if(highlightInterval) clearInterval(highlightInterval);

            try {
                const coords = await getCoordinatesForCity(city);
                const times = SunCalc.getTimes(date, coords.lat, coords.lon);
                const sunrise = times.sunrise, sunset = times.sunset;
                const tomorrow = new Date(date); tomorrow.setDate(date.getDate() + 1);
                const tomorrowSunrise = SunCalc.getTimes(tomorrow, coords.lat, coords.lon).sunrise;

                sunriseTimeEl.textContent = formatTime(sunrise);
                sunsetTimeEl.textContent = formatTime(sunset);

                const dayDuration = (sunset.getTime() - sunrise.getTime());
                const nightDuration = (tomorrowSunrise.getTime() - sunset.getTime());
                const dayOfWeek = date.getDay();

                // Horas
                const dayHoras = generateHoras(dayOfWeek, sunrise.getTime(), dayDuration / 12);
                const nightHoras = generateHoras((dayOfWeek + 4) % 7, sunset.getTime(), nightDuration / 12);
                populateTimingsTable(dayHoraContainer, dayHoras);
                populateTimingsTable(nightHoraContainer, nightHoras);
                
                // Choghadiyas
                const dayChoghadiyas = generateChoghadiyas(CHOGHADIYA_DAY_ORDER[dayOfWeek], sunrise.getTime(), dayDuration / 8);
                const nightChoghadiyas = generateChoghadiyas(CHOGHADIYA_NIGHT_ORDER[dayOfWeek], sunset.getTime(), nightDuration / 8);
                populateTimingsTable(dayChoghadiyaContainer, dayChoghadiyas);
                populateTimingsTable(nightChoghadiyaContainer, nightChoghadiyas);

                // Best Timings
                const bestTimes = calculateBestTimes(dayHoras.concat(nightHoras), dayChoghadiyas.concat(nightChoghadiyas));
                renderBestTimes(bestTimes);

                timingsContent.classList.remove('hidden');
                highlightCurrentPeriods();
                highlightInterval = setInterval(highlightCurrentPeriods, 30000);
            } catch (err) {
                timingsError.textContent = `Error: ${err.message}. Please check the city name and try again.`;
                timingsError.classList.remove('hidden');
            } finally {
                timingsLoader.classList.add('hidden');
            }
        }

        function generateHoras(dayOfWeek, startTime, duration) {
            const horas = [];
            let lordIndex = [0, 3, 6, 2, 5, 1, 4][dayOfWeek];
            for (let i = 0; i < 12; i++) {
                const currentLord = horaLords[(lordIndex + i) % 7];
                horas.push({ name: currentLord, start: startTime + i * duration, end: startTime + (i + 1) * duration });
            }
            return horas;
        }

        function generateChoghadiyas(sequence, startTime, duration) {
            return sequence.map((type, i) => ({ ...type, start: startTime + i * duration, end: startTime + (i + 1) * duration }));
        }

        function calculateBestTimes(horas, choghadiyas) {
            const bestTimes = [];
            horas.forEach(hora => {
                if (BEST_HORA_PLANETS.includes(hora.name)) {
                    choghadiyas.forEach(choghadiya => {
                        if (BEST_CHOGHADIYA_TYPES.includes(choghadiya.name)) {
                            const overlapStart = Math.max(hora.start, choghadiya.start);
                            const overlapEnd = Math.min(hora.end, choghadiya.end);
                            if (overlapStart < overlapEnd) {
                                bestTimes.push({ start: overlapStart, end: overlapEnd, hora: hora.name, choghadiya: choghadiya.name });
                            }
                        }
                    });
                }
            });
            return bestTimes;
        }

        function populateTimingsTable(container, items) {
            let tableHTML = `<table class="w-full text-left border-collapse"><thead><tr class="border-b bg-gray-100"><th class="p-2 text-xs font-semibold">#</th><th class="p-2 text-xs font-semibold">Lord/Type</th><th class="p-2 text-xs font-semibold">Time</th></tr></thead><tbody>`;
            items.forEach((item, i) => {
                tableHTML += `<tr data-start="${item.start}" data-end="${item.end}">
                    <td class="p-2 border-t">${i+1}</td>
                    <td class="p-2 border-t font-bold ${item.color || ''}">${item.name}</td>
                    <td class="p-2 border-t text-sm">${formatTime(new Date(item.start))} - ${formatTime(new Date(item.end))}</td>
                </tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function renderBestTimes(bestTimes) {
            let tableHTML = `<table class="w-full text-left border-collapse"><thead><tr class="border-b bg-gray-100"><th class="p-2 text-xs font-semibold">Start</th><th class="p-2 text-xs font-semibold">End</th><th class="p-2 text-xs font-semibold">Hora</th><th class="p-2 text-xs font-semibold">Choghadiya</th></tr></thead><tbody>`;
            if (bestTimes.length > 0) {
                bestTimes.forEach(t => {
                    tableHTML += `<tr><td class="p-2 border-t font-bold">${formatTime(new Date(t.start))}</td><td class="p-2 border-t font-bold">${formatTime(new Date(t.end))}</td><td class="p-2 border-t">${t.hora}</td><td class="p-2 border-t">${t.choghadiya}</td></tr>`;
                });
            } else {
                tableHTML += `<tr><td colspan="4" class="p-4 text-center text-gray-500">No highly auspicious overlapping periods found.</td></tr>`;
            }
            tableHTML += `</tbody></table>`;
            bestTimesContainer.innerHTML = tableHTML;
        }
        
        function highlightCurrentPeriods() {
            const now = Date.now();
            document.querySelectorAll('#timings-content tbody tr').forEach(row => {
                const start = parseInt(row.dataset.start);
                const end = parseInt(row.dataset.end);
                if (now >= start && now < end) {
                    row.classList.add('current-period');
                } else {
                    row.classList.remove('current-period');
                }
            });
        }

        function formatTime(date) { return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); }
        
        function displayResults(results, dateRange) {
            summaryOutputDiv.innerHTML = ''; outputDiv.innerHTML = '';
            if (results.length === 0) { outputDiv.innerHTML = '<p class="text-center p-4">No results.</p>'; return; }
            const goodDaysCount = results.filter(day => day.isFinalGood).length;
            summaryOutputDiv.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg"><p class="font-bold">Summary for ${dateRange.start} to ${dateRange.end}</p><p>Found <strong class="text-xl">${goodDaysCount}</strong> favorable day(s).</p></div>`;
            const table = document.createElement('table');
            table.className = 'w-full text-left border-collapse';
            table.innerHTML = `<thead class="border-b bg-gray-100"><tr><th class="p-3 text-sm font-semibold w-[15%]">Date</th><th class="p-3 text-sm font-semibold w-[15%]">Moon Nakshatra</th><th class="p-3 text-sm font-semibold w-[20%]">Nakshatra Result</th><th class="p-3 text-sm font-semibold w-[15%]">Moon Rashi</th><th class="p-3 text-sm font-semibold w-[15%]">Rashi Result</th><th class="p-3 text-sm font-semibold w-[20%] text-right pr-10">Verdict</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            results.forEach(day => {
                const nakshatraResultHtml = day.isNakshatraGood ? `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Good</span><span class="ml-2 text-xs text-gray-600">(${day.taraType})</span>` : `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">Avoid</span><span class="ml-2 text-xs text-gray-600">(${day.taraType})</span>`;
                const rashiResultHtml = day.isRashiGood ? `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Good</span>` : `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">Bad</span>`;
                const finalResultHtml = day.isFinalGood ? `<span class="px-3 py-1 font-bold text-base text-green-900 bg-green-300 rounded-full">Good Day</span>` : `<span class="px-3 py-1 font-bold text-base text-red-900 bg-red-300 rounded-full">Avoid</span>`;
                const row = document.createElement('tr');
                row.className = 'border-b last:border-b-0';
                row.innerHTML = `<td colspan="6" class="p-0"><details class="group"><summary class="grid grid-cols-[15%_15%_20%_15%_15%_20%] items-center cursor-pointer p-3 hover:bg-gray-50"><span class="font-semibold">${day.date}</span><span>${day.nakshatra}</span><span class="flex items-center">${nakshatraResultHtml}</span><span>${day.rashi}</span><span class="flex items-center">${rashiResultHtml}</span><div class="flex items-center justify-end pr-4">${finalResultHtml}<span class="ml-auto pl-4 text-gray-500 group-open:rotate-90 transition-transform">&#9654;</span></div></summary><div class="p-4 bg-gray-50 border-t"><h4 class="font-semibold mb-2">Day Details:</h4><p class="text-gray-600 mb-2"><strong>Nakshatra:</strong> ${day.taraType} - ${taraBalaDescriptions[day.taraType]}.</p><p class="text-gray-600 mb-4"><strong>Rashi:</strong> ${day.isRashiGood ? 'Favorable transit.' : 'Chandrashtama (unfavorable transit).'}</p><button data-date="${day.fullDate.toISOString()}" class="timings-details-btn inline-block bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">View Detailed Timings</button></div></details></td>`;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            outputDiv.appendChild(table);
        }

        // --- EVENT HANDLERS ---
        function handleAnalysis() {
            const startDate = new Date(startDateElement.value);
            const endDate = new Date(endDateElement.value);
            errorMessageDiv.classList.add('hidden');
            if (!startDateElement.value || !endDateElement.value || endDate < startDate || !locationInput.value) {
                errorMessageDiv.textContent = 'Please select a valid start/end date and enter a city name.';
                errorMessageDiv.classList.remove('hidden'); return;
            }
            if (Math.round(Math.abs((endDate - startDate) / 864e5)) > 30) {
                errorMessageDiv.textContent = 'Please select a date range of 31 days or less.';
                errorMessageDiv.classList.remove('hidden'); return;
            }
            resultsContainer.classList.remove('hidden'); loader.classList.remove('hidden');
            summaryOutputDiv.innerHTML = ''; outputDiv.classList.add('hidden');
            analyzeBtn.disabled = true; analyzeBtn.textContent = 'Analyzing...';
            setTimeout(() => {
                try {
                    const transitForecast = getMoonTransitForecast(startDate, endDate);
                    const analysisResults = analyzeTransits(selectNakshatraElement.value, selectRashiElement.value, transitForecast);
                    const dateRange = { start: startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }), end: endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }) };
                    displayResults(analysisResults, dateRange);
                    outputDiv.classList.remove('hidden');
                } catch (error) {
                    errorMessageDiv.textContent = `An unexpected error occurred: ${error.message}`;
                    errorMessageDiv.classList.remove('hidden');
                } finally {
                    loader.classList.add('hidden');
                    analyzeBtn.disabled = false; analyzeBtn.textContent = 'Analyze My Days';
                }
            }, 500);
        }

        outputDiv.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('timings-details-btn')) {
                const date = new Date(e.target.dataset.date);
                const city = locationInput.value;
                if(city) {
                    calculateAndDisplayTimings(date, city);
                } else {
                    errorMessageDiv.textContent = 'Please enter a city name before calculating timings.';
                    errorMessageDiv.classList.remove('hidden');
                }
            }
        });

        // --- SCRIPT EXECUTION ON PAGE LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();
            setInitialDates();
            analyzeBtn.addEventListener('click', handleAnalysis);
            backToAnalyzerBtn.addEventListener('click', showAnalyzerPage);
        });
    </script>
</body>
</html>
